<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ync.schedule.mapper.ExpenseReportMapper">

    <resultMap id="ExpenseReportResultMap" type="com.ync.schedule.domain.ExpenseReport">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="title" column="title"/>
        <result property="reportMonth" column="report_month"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="filePath" column="file_path"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <association property="member" javaType="com.ync.schedule.domain.Member">
            <id property="id" column="member_id"/>
            <result property="name" column="member_name"/>
            <result property="departmentId" column="member_department_id"/>
        </association>
    </resultMap>

    <resultMap id="ExpenseReportDtoResultMap" type="com.ync.schedule.dto.ExpenseReportDto">
        <id property="id" column="id"/>
        <result property="memberId" column="member_id"/>
        <result property="memberName" column="member_name"/>
        <result property="departmentName" column="department_name"/>
        <result property="title" column="title"/>
        <result property="reportMonth" column="report_month"/>
        <result property="totalAmount" column="total_amount"/>
        <result property="description" column="description"/>
        <result property="status" column="status"/>
        <result property="filePath" column="file_path"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <select id="findAll" resultMap="ExpenseReportDtoResultMap">
        SELECT er.*,
               m.name as member_name,
               d.name as department_name
        FROM expense_reports er
        LEFT JOIN members m ON er.member_id = m.id
        LEFT JOIN departments d ON m.department_id = d.id
        ORDER BY er.report_month DESC, er.created_at DESC
    </select>

    <select id="findById" resultMap="ExpenseReportResultMap">
        SELECT er.*,
               m.name as member_name,
               m.department_id as member_department_id
        FROM expense_reports er
        LEFT JOIN members m ON er.member_id = m.id
        WHERE er.id = #{id}
    </select>

    <select id="findByMemberId" resultMap="ExpenseReportDtoResultMap">
        SELECT er.*,
               m.name as member_name,
               d.name as department_name
        FROM expense_reports er
        LEFT JOIN members m ON er.member_id = m.id
        LEFT JOIN departments d ON m.department_id = d.id
        WHERE er.member_id = #{memberId}
        ORDER BY er.report_month DESC, er.created_at DESC
    </select>

    <select id="findByMonth" resultMap="ExpenseReportDtoResultMap">
        SELECT er.*,
               m.name as member_name,
               d.name as department_name
        FROM expense_reports er
        LEFT JOIN members m ON er.member_id = m.id
        LEFT JOIN departments d ON m.department_id = d.id
        WHERE TRUNC(er.report_month, 'MONTH') = TRUNC(#{reportMonth}, 'MONTH')
        ORDER BY er.created_at DESC
    </select>

    <select id="findByStatus" resultMap="ExpenseReportDtoResultMap">
        SELECT er.*,
               m.name as member_name,
               d.name as department_name
        FROM expense_reports er
        LEFT JOIN members m ON er.member_id = m.id
        LEFT JOIN departments d ON m.department_id = d.id
        WHERE er.status = #{status}
        ORDER BY er.report_month DESC, er.created_at DESC
    </select>

    <insert id="insert" parameterType="com.ync.schedule.domain.ExpenseReport">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT expense_reports_seq.NEXTVAL FROM dual
        </selectKey>
        INSERT INTO expense_reports (
            id,
            member_id,
            title,
            report_month,
            total_amount,
            <if test="description != null">description,</if>
            status,
            <if test="filePath != null">file_path,</if>
            created_at,
            updated_at
        )
        VALUES (
            #{id},
            #{memberId},
            #{title, jdbcType=VARCHAR},
            #{reportMonth, jdbcType=DATE},
            #{totalAmount, jdbcType=DECIMAL},
            <if test="description != null">#{description, jdbcType=VARCHAR},</if>
            #{status, jdbcType=VARCHAR},
            <if test="filePath != null">#{filePath, jdbcType=VARCHAR},</if>
            CURRENT_TIMESTAMP,
            CURRENT_TIMESTAMP
        )
    </insert>

    <update id="update" parameterType="com.ync.schedule.domain.ExpenseReport">
        UPDATE expense_reports
        <set>
            member_id = #{memberId},
            title = #{title, jdbcType=VARCHAR},
            report_month = #{reportMonth, jdbcType=DATE},
            total_amount = #{totalAmount, jdbcType=DECIMAL},
            <if test="description != null">
                description = #{description, jdbcType=VARCHAR},
            </if>
            status = #{status, jdbcType=VARCHAR},
            <if test="filePath != null">
                file_path = #{filePath, jdbcType=VARCHAR},
            </if>
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM expense_reports WHERE id = #{id}
    </delete>

</mapper>
