<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì§€ì¶œ ë‚´ì—­ ê´€ë¦¬</title>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='6' y='10' width='52' height='48' rx='12' fill='%235b6cff'/%3E%3Crect x='6' y='18' width='52' height='40' rx='10' fill='%23ffffff'/%3E%3Crect x='6' y='10' width='52' height='14' rx='12' fill='%238b5cf6'/%3E%3Cpath d='M18 34h28v4H18zM18 42h18v4H18z' fill='%235b6cff'/%3E%3C/svg%3E"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@200..700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#0b1220;
      --panel:rgba(255,255,255,.92);
      --panel2:rgba(255,255,255,.98);
      --border:rgba(15,23,42,.10);
      --text:#0f172a;
      --muted:#64748b;
      --primary:#6366f1;
      --primary2:#8b5cf6;
      --danger:#ef4444;
      --success:#10b981;
      --warning:#f59e0b;
      --shadow:0 22px 60px rgba(15,23,42,.22);
      --shadow2:0 10px 30px rgba(15,23,42,.14);
      --r-xl:20px; --r:14px; --r-sm:10px;
      --focus:0 0 0 4px rgba(99,102,241,.16);
      --transition:all .18s cubic-bezier(.4,0,.2,1);
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Apple SD Gothic Neo","Noto Sans KR",Roboto,Arial,sans-serif;
      background:radial-gradient(1200px 700px at 20% 10%, rgba(99, 102, 241, .35), transparent 55%),
                 radial-gradient(900px 600px at 85% 15%, rgba(139, 92, 246, .30), transparent 55%),
                 radial-gradient(800px 600px at 60% 90%, rgba(16, 185, 129, .18), transparent 55%),
                 linear-gradient(180deg, #9fa5b4 0%, #5c9fb6 100%);
      color:#e5e7eb;
      min-height:100vh;
      padding:22px;
    }
    .wrap{max-width:1600px;margin:0 auto;display:grid;grid-template-columns:350px 1fr;gap:18px;align-items:start;}
    .card{
      background:var(--panel);
      color:var(--text);
      border-radius:var(--r-xl);
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.14);
      overflow:hidden;
    }
    .card .head{
      padding:18px 18px 14px 18px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background:linear-gradient(135deg, rgba(99,102,241,.08), rgba(139,92,246,.08));
    }
    .title{
      font-size:18px;font-weight:900;letter-spacing:-.4px;
      display:flex; align-items:center; gap:10px;
    }
    .title small{font-size:12px;font-weight:800;color:var(--muted);}
    .chip{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900;
      background:#eef2ff;color:#3730a3;border:1px solid rgba(55,48,163,.14);
      white-space:nowrap;
    }
    .body{padding:16px 18px;}
    label{display:block;font-size:12px;font-weight:900;color:#0f172a;margin:0 0 6px 2px;}
    select,input,textarea{
      width:100%;
      border:2px solid var(--border);
      border-radius:12px;
      padding:8px 12px;
      font-size:13px;
      background:#fff;
      outline:none;
      transition:var(--transition);
      box-shadow:0 2px 10px rgba(15,23,42,.06);
    }
    select{
      cursor:pointer;
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 10px center;
      padding-right:32px;
    }
    select:focus,input:focus{border-color:var(--primary);box-shadow:var(--focus);}
    .btn{
      border:none; cursor:pointer;
      padding:10px 14px; border-radius:12px;
      font-weight:900; font-size:13px;
      transition:var(--transition);
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      box-shadow:0 4px 14px rgba(15,23,42,.10);
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow2);}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;}
    .btn-ghost{background:#fff;color:#0f172a;border:2px solid var(--border);}
    .btn-danger{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff;}
    .btn-success{background:linear-gradient(135deg,#10b981,#059669);color:#fff;}
    .statbar{
      display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;
      margin-top:10px;
    }
    .stat{
      background:#fff; border:1px solid var(--border);
      border-radius:14px; padding:12px;
      white-space:nowrap;
      display:inline-block;
    }
    .stat .k{font-size:11px;font-weight:900;color:var(--muted);}
    .stat .v{font-size:25px;font-weight:1000;margin-top:6px;white-space:nowrap;display:inline-block;}
    .v span{font-family:"Oswald",sans-serif;font-optical-sizing:auto;font-weight:bold;font-style:normal;}
    .stat .v small{font-size:12px;font-weight:900;color:var(--muted);}
    .mainTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-bottom:12px;
    }
    .mainTop .left{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
    .search{
      min-width:260px;
      background:var(--panel2);
      color:var(--text);
      border-radius:999px;
      padding:10px 14px;
      border:2px solid rgba(255,255,255,.35);
      outline:none;
      box-shadow:0 10px 25px rgba(0,0,0,.18);
    }
    .tableWrap{background:var(--panel); color:var(--text); border-radius:var(--r-xl); box-shadow:var(--shadow); overflow:hidden; text-align:center;}
    .tableWrap thead th{text-align:center;}
    .tableWrap tbody td{vertical-align:middle;}
    .tableWrap tbody td:nth-child(9){text-align:left;}
    table{width:100%; border-collapse:separate; border-spacing:0;}
    thead th{
      font-size:11px;
      font-weight:1000;
      color:#0f172a;
      padding:10px 8px;
      background:linear-gradient(135deg, rgba(99,102,241,.12), rgba(139,92,246,.12));
      border-bottom:1px solid var(--border);
      position:sticky; top:0; z-index:2;
    }
    tbody td{
      padding:8px 8px;
      border-bottom:1px solid rgba(15,23,42,.07);
      font-size:12px;
    }
    tbody tr:hover td{background:rgba(99,102,241,.06);}
    .num{text-align:right; font-variant-numeric:tabular-nums;}
    .linkBtn{padding:6px 8px;border-radius:8px;border:2px solid var(--border);background:#fff;font-weight:1000;cursor:pointer;font-size:11px;}
    .linkBtn:hover{border-color:var(--primary);color:var(--primary);}
    .foot{padding:12px 14px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; border-top:1px solid var(--border); background:rgba(255,255,255,.7);}
    .tiny{font-size:10.5px;color:#7b86ac;font-weight:600;}
    .modal{
      display:none; position:fixed; inset:0; background:rgba(0,0,0,.55);
      z-index:999; padding:20px; overflow:auto;
    }
    .modal.show{display:block;}
    .modal .panel{
      max-width:720px; margin:40px auto; background:#fff; color:var(--text);
      border-radius:var(--r-xl); box-shadow:0 30px 90px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal .panel .head{background:#fff;}
    .modal .panel .body{padding:16px 18px 18px;}
    .modal .x{cursor:pointer; padding:8px 10px;border-radius:10px;font-size:20px;color:var(--muted);}
    .modal .x:hover{background:#f1f5f9;}
    .hr{height:1px;background:rgba(15,23,42,.10);margin:10px 0;}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width: 1200px){
      .wrap{grid-template-columns:1fr;}
      .search{width:100%; min-width:0;}
    }
  </style>
</head>
<body>

<div class="wrap">
  <!-- Sidebar -->
  <section class="card">
    <div class="head">
      <div class="title" style="white-space:nowrap;">ğŸ’° ì§€ì¶œ ë‚´ì—­</div>
      <div style="display:flex;align-items:center;gap:6px;flex-wrap:nowrap;">
        <button class="btn btn-primary" id="btnBackToSchedule" style="padding:6px 12px;font-size:11px;background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);border:none;font-weight:600;">ğŸ“… ì¼ì •ê´€ë¦¬</button>
        <button class="btn btn-success" id="btnMapPage" style="padding:6px 12px;font-size:11px;background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);border:none;font-weight:600;">ğŸ½ï¸ ë§›ì§‘ì§€ë„</button>
      </div>
    </div>
    <div class="body">
      <div style="margin-bottom:12px;">
        <label>ë³¸ë¶€</label>
        <select id="filterParentDept">
          <option value="">ì „ì²´ ë³¸ë¶€</option>
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label>íŒ€</label>
        <select id="filterChildDept">
          <option value="">ì „ì²´ íŒ€</option>
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label>ë©¤ë²„</label>
        <select id="filterMember">
          <option value="">ì „ì²´ ë©¤ë²„</option>
        </select>
      </div>
      <div style="margin-bottom:12px;">
        <label>ë…„ì›” ì„ íƒ</label>
        <input type="month" id="filterMonth" style="width:100%;padding:8px 12px;border:2px solid var(--border);border-radius:12px;font-size:13px;background:#fff;outline:none;" />
      </div>

      <div class="hr"></div>

      <div class="statbar">
        <div class="stat">
          <div class="k">ì´ ê±´ìˆ˜</div>
          <div class="v"><span id="statCount">0</span><small> ê±´</small></div>
        </div>
        <div class="stat">
          <div class="k">í•©ê³„ ê¸ˆì•¡</div>
          <div class="v"><span id="statSum">0</span><small> ì›</small></div>
        </div>
        <div class="stat">
          <div class="k">í‰ê· </div>
          <div class="v"><span id="statAvg">0</span><small> ì›</small></div>
        </div>
      </div>

      <div class="hr"></div>

      <!-- Welfare Usage Section -->
      <div id="welfareSection" style="display:none;margin-bottom:12px;">
        <div style="font-size:13px;font-weight:600;margin-bottom:8px;color:#333;">ë³µì§€ë¹„ ì‚¬ìš© í˜„í™©</div>
        <div id="welfareQuarters" style="display:flex;flex-direction:column;gap:4px;margin-bottom:8px;">
          <!-- Quarterly usage will be dynamically inserted here -->
        </div>
        <div style="display:flex;justify-content:space-between;padding:6px 8px;background:rgba(99,102,241,0.1);border-radius:6px;font-size:12px;">
          <span style="font-weight:600;">ì—°ê°„ í•©ê³„</span>
          <span><b id="welfareAnnualUsed">0</b> / <span id="welfareAnnualBudget">1,600,000</span>ì›</span>
        </div>
        <div style="font-size:11px;color:#666;margin-top:4px;">
          ë‚¨ì€ ê¸ˆì•¡: <b id="welfareAnnualRemaining" style="color:#059669;">0</b>ì›
        </div>
      </div>

      <div class="hr"></div>

      <div style="display:flex;flex-direction:column;gap:8px;">
        <button class="btn btn-primary" id="btnNew">+ ì§€ì¶œ ì¶”ê°€</button>
        <button class="btn btn-success" id="btnExportExcel">ğŸ“¥ ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
        <button class="btn btn-ghost" id="btnResetFilter">í•„í„° ì´ˆê¸°í™”</button>
      </div>

      <div class="tiny" style="margin-top:12px;">
        íŒ) ë³¸ë¶€/íŒ€/ë©¤ë²„ ì„ íƒí•˜ì—¬ í•„í„°ë§. í–‰ [ìˆ˜ì •]ìœ¼ë¡œ í¸ì§‘ ê°€ëŠ¥.
      </div>
    </div>
  </section>

  <!-- Main Area -->
  <section>
    <div class="mainTop">
      <div class="left">
        <span class="chip">í‘œì‹œ ê±´ìˆ˜: <b id="shownCount">0</b></span>
        <span class="chip">í‘œì‹œ í•©ê³„: <b id="shownSum">0</b>ì›</span>
        <button class="btn btn-primary" id="btnAddRow" style="display:none;padding:6px 12px;font-size:12px;margin-left:8px;">+ í–‰ ì¶”ê°€</button>
        <button class="btn btn-success" id="btnSaveBulk" style="display:none;padding:6px 12px;font-size:12px;margin-left:8px;">ğŸ’¾ ì¼ê´„ ì €ì¥</button>
      </div>
      <input class="search" id="q" placeholder="ê²€ìƒ‰: ì‚¬ìš©ë‚´ìš©/ì—…ì†Œ/ë©”ëª¨ ..." />
    </div>

    <div class="tableWrap">
      <div style="max-height:calc(100vh - 120px); overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="width:90px;">ì‚¬ìš©ì</th>
              <th style="width:90px;">ì‚¬ìš©ì¼ì‹œ</th>
              <th>ì‚¬ìš© ë‚´ìš©</th>
              <th style="width:100px;">ê³„ì •</th>
              <th class="num" style="width:90px;">ì‚¬ìš©ê¸ˆì•¡</th>
              <th style="width:120px;">ì—…ì†Œëª…</th>
              <th style="width:100px;">ê²½ë¹„ì½”ë“œ</th>
              <th style="width:110px;">í”„ë¡œì íŠ¸ì½”ë“œ</th>
              <th style="width:200px;">ë©”ëª¨</th>
              <th style="width:80px;">ë³µì§€ë¹„</th>
              <th style="width:100px;">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="foot">
        <div class="tiny">ë°ì´í„°: <b>ì„œë²„ API ì—°ë™</b></div>
        <div class="tiny">ë³¸ë¶€/íŒ€/ë©¤ë²„ ì„ íƒ í›„ í•„í„°ë§. í–‰ [ìˆ˜ì •]ìœ¼ë¡œ í¸ì§‘ ê°€ëŠ¥.</div>
      </div>
    </div>
  </section>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="head">
      <div class="title" id="mTitle">ì§€ì¶œ ì¶”ê°€</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <span class="x" id="btnClose">âœ•</span>
      </div>
    </div>
    <div class="body">
      <input type="hidden" id="mId" />
      <div class="grid2">
        <div>
          <label>ì‚¬ìš©ì¼ì‹œ *</label>
          <input id="mDate" type="date" required />
        </div>
        <div>
          <label>ì‚¬ìš©ì *</label>
          <select id="mMember" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>
        <div>
          <label>ì—…ì†Œëª…</label>
          <input id="mVendor" placeholder="ì˜ˆ: ìŠ¤íƒ€ë²…ìŠ¤" />
        </div>
        <div>
          <label>ê¸ˆì•¡ *</label>
          <input id="mAmount" type="number" min="0" step="1" required />
        </div>
        <div>
          <label>ê³„ì • *</label>
          <select id="mAccount" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì•¼íŠ¹ê·¼ì‹ë¹„">ì•¼íŠ¹ê·¼ì‹ë¹„</option>
            <option value="íšŒì‹ë¹„">íšŒì‹ë¹„</option>
            <option value="ì ‘ëŒ€ë¹„">ì ‘ëŒ€ë¹„</option>
            <option value="êµí†µë¹„">êµí†µë¹„</option>
            <option value="í†µì‹ ë¹„">í†µì‹ ë¹„</option>
            <option value="ì‚¬ë¬´ë¹„">ì‚¬ë¬´ë¹„</option>
            <option value="ì¶œì¥ì¼ë¹„">ì¶œì¥ì¼ë¹„</option>
            <option value="ë³µë¦¬í›„ìƒë¹„">ë³µë¦¬í›„ìƒë¹„</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div>
          <label>ê²½ë¹„ì½”ë“œ</label>
          <select id="mCost">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë²•ì¸(ë²•ì¸)">ë²•ì¸(ë²•ì¸)</option>
            <option value="ë²•ì¸(ê°œì¸)">ë²•ì¸(ê°œì¸)</option>
            <option value="ê°œì¸(ê°œì¸)">ê°œì¸(ê°œì¸)</option>
            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div>
          <label>í”„ë¡œì íŠ¸ì½”ë“œ</label>
          <input id="mProject" value="PJ00000000" />
        </div>
        <div>
          <label>ì‚¬ìš© ë‚´ìš© *</label>
          <input id="mDesc" placeholder="ì˜ˆ: ì ì‹¬ ì‹ì‚¬" required />
        </div>
      </div>

      <div style="margin-top:12px;">
        <label>ë©”ëª¨(ìš©ë„/ì°¸ì„ì ë“±)</label>
        <textarea id="mNote" placeholder="7ë§Œì› ì´ìƒ ë¹„ìš© ë°œìƒ ì‹œ ì°¸ì„ì/ìš©ë„ ê¸°ì…" style="min-height:60px;resize:vertical;"></textarea>
      </div>

      <div id="welfareFlagContainer" style="margin-top:12px;display:none;">
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="mWelfareFlag" style="width:18px;height:18px;cursor:pointer;" />
          <span>ë³µì§€ë¹„ ì—¬ë¶€</span>
        </label>
        <div class="tiny" style="margin-top:4px;color:#666;">
          ë¶„ê¸°ë‹¹ 40ë§Œì› (ì—°ê°„ 160ë§Œì›)
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px;">
        <button class="btn btn-danger" id="btnDelete" style="display:none;">ì‚­ì œ</button>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-ghost" id="btnCancel">ì·¨ì†Œ</button>
          <button class="btn btn-primary" id="btnSave">ì €ì¥</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = '/api';
  const nf = new Intl.NumberFormat("ko-KR");
  const $ = (q) => document.querySelector(q);

  let departments = [];
  let members = [];
  let items = [];
  let currentItem = null;
  let bulkEditRows = []; // ì¼ê´„ í¸ì§‘ìš© ì„ì‹œ í–‰ë“¤

  const dom = {
    filterParentDept: $("#filterParentDept"),
    filterChildDept: $("#filterChildDept"),
    filterMember: $("#filterMember"),
    filterMonth: $("#filterMonth"),
    statCount: $("#statCount"),
    statSum: $("#statSum"),
    statAvg: $("#statAvg"),
    q: $("#q"),
    tbody: $("#tbody"),
    shownCount: $("#shownCount"),
    shownSum: $("#shownSum"),
    modal: $("#modal"),
    mTitle: $("#mTitle"),
    mId: $("#mId"),
    mDate: $("#mDate"),
    mMember: $("#mMember"),
    mVendor: $("#mVendor"),
    mAmount: $("#mAmount"),
    mAccount: $("#mAccount"),
    mCost: $("#mCost"),
    mProject: $("#mProject"),
    mDesc: $("#mDesc"),
    mNote: $("#mNote"),
    mWelfareFlag: $("#mWelfareFlag"),
    btnNew: $("#btnNew"),
    btnAddRow: $("#btnAddRow"),
    btnSaveBulk: $("#btnSaveBulk"),
    btnClose: $("#btnClose"),
    btnCancel: $("#btnCancel"),
    btnSave: $("#btnSave"),
    btnDelete: $("#btnDelete"),
    btnResetFilter: $("#btnResetFilter"),
    btnBackToSchedule: $("#btnBackToSchedule"),
    btnMapPage: $("#btnMapPage"),
    btnExportExcel: $("#btnExportExcel"),
    welfareSection: $("#welfareSection"),
    welfareQuarters: $("#welfareQuarters"),
    welfareAnnualUsed: $("#welfareAnnualUsed"),
    welfareAnnualBudget: $("#welfareAnnualBudget"),
    welfareAnnualRemaining: $("#welfareAnnualRemaining"),
    welfareFlagContainer: $("#welfareFlagContainer"),
  };

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[m]); }
  function sum(list){ return list.reduce((a,b)=>a + (Number(b.amount)||0), 0); }
  function openModal(){ dom.modal.classList.add("show"); }
  function closeModal(){ dom.modal.classList.remove("show"); }
  function formatDate(d){
    if(!d) return "-";
    const date = new Date(d);
    const month = date.getMonth() + 1;
    const day = date.getDate();
    return `${month}/${day}`;
  }
  function todayISO(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`; }

  async function loadDepartments(){
    try{
      const res = await fetch(`${API_BASE}/departments`);
      departments = await res.json();

      const parentDepts = departments.filter(d => d.depth === 0);
      parentDepts.forEach(d => {
        const opt = new Option(d.name, d.id);
        dom.filterParentDept.add(opt);
      });
    }catch(e){ console.error('ë¶€ì„œ ë¡œë“œ ì‹¤íŒ¨:', e); }
  }

  async function loadMembers(){
    try{
      const res = await fetch(`${API_BASE}/members`);
      members = await res.json();
      [dom.filterMember, dom.mMember].forEach(sel => {
        members.forEach(m => {
          const deptName = m.department || '';
          const opt = new Option(`${m.name} (${deptName})`, m.id);
          sel.add(opt.cloneNode(true));
        });
      });
    }catch(e){ console.error('ë©¤ë²„ ë¡œë“œ ì‹¤íŒ¨:', e); }
  }

  async function loadItems(){
    try{
      const res = await fetch(`${API_BASE}/expense-items`);
      if(!res.ok){
        console.error('API ì˜¤ë¥˜:', res.status);
        items = [];
        renderTable();
        return;
      }
      const data = await res.json();
      items = Array.isArray(data) ? data : [];
      renderTable();
    }catch(e){
      console.error('ì§€ì¶œ ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨:', e);
      items = [];
      renderTable();
    }
  }

  function applyFilters(){
    const q = (dom.q.value||"").trim().toLowerCase();
    const mem = dom.filterMember.value||"";
    const month = dom.filterMonth.value||"";
    const parentDept = dom.filterParentDept.value||"";
    const childDept = dom.filterChildDept.value||"";

    return items.filter(x => {
      // ë³¸ë¶€/íŒ€/ë©¤ë²„ í•„í„° (ê³„ì¸µì ìœ¼ë¡œ ì ìš©)
      if(mem){
        // ë©¤ë²„ê°€ ì„ íƒë˜ë©´ í•´ë‹¹ ë©¤ë²„ë§Œ
        if(x.memberId != mem) return false;
      } else if(childDept){
        // íŒ€ì´ ì„ íƒë˜ë©´ í•´ë‹¹ íŒ€ì˜ ë©¤ë²„ë“¤ë§Œ
        const member = members.find(m => m.id == x.memberId);
        if(!member || member.departmentId != childDept) return false;
      } else if(parentDept){
        // ë³¸ë¶€ê°€ ì„ íƒë˜ë©´ í•´ë‹¹ ë³¸ë¶€ ì†Œì† íŒ€ë“¤ì˜ ë©¤ë²„ë“¤ë§Œ
        const childDepts = departments.filter(d => d.parentId == parentDept);
        const childDeptIds = childDepts.map(d => d.id);
        const member = members.find(m => m.id == x.memberId);
        if(!member || !childDeptIds.includes(member.departmentId)) return false;
      }

      // ì›” í•„í„° (YYYY-MM í˜•ì‹)
      if(month && x.usageDate){
        const itemMonth = x.usageDate.substring(0, 7); // YYYY-MM-DDì—ì„œ YYYY-MM ì¶”ì¶œ
        if(itemMonth !== month) return false;
      }

      // ê²€ìƒ‰ì–´ í•„í„°
      if(q){
        const hay = `${x.description||""} ${x.vendor||""} ${x.note||""} ${x.account||""} ${x.costCode||""} ${x.projectCode||""}`.toLowerCase();
        if(hay.indexOf(q)===-1) return false;
      }

      return true;
    }).sort((a,b)=> (a.usageDate||"").localeCompare(b.usageDate||""));
  }

  function renderTable(){
    const filtered = applyFilters();
    const s = sum(filtered);
    const avg = filtered.length > 0 ? Math.round(s / filtered.length) : 0;

    dom.shownCount.textContent = nf.format(filtered.length);
    dom.shownSum.textContent = nf.format(s);

    // ì¼ê´„ í¸ì§‘ í–‰ ë Œë”ë§
    const bulkRowsHTML = bulkEditRows.map((row, idx) => {
      const showWelfareCheckbox = row.account === 'ë³µë¦¬í›„ìƒë¹„';
      return `
      <tr class="bulk-edit-row" data-bulk-idx="${idx}" style="background:#fffbeb;">
        <td style="font-size:13px;font-weight:700;">${esc(row.memberName||"-")}</td>
        <td><input type="date" class="bulk-input" data-field="usageDate" data-idx="${idx}" value="${row.usageDate||''}" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td><input type="text" class="bulk-input" data-field="description" data-idx="${idx}" value="${row.description||''}" placeholder="ì‚¬ìš©ë‚´ìš©" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td>
          <select class="bulk-input bulk-account" data-field="account" data-idx="${idx}" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ì•¼íŠ¹ê·¼ì‹ë¹„" ${row.account==='ì•¼íŠ¹ê·¼ì‹ë¹„'?'selected':''}>ì•¼íŠ¹ê·¼ì‹ë¹„</option>
            <option value="íšŒì‹ë¹„" ${row.account==='íšŒì‹ë¹„'?'selected':''}>íšŒì‹ë¹„</option>
            <option value="ì ‘ëŒ€ë¹„" ${row.account==='ì ‘ëŒ€ë¹„'?'selected':''}>ì ‘ëŒ€ë¹„</option>
            <option value="êµí†µë¹„" ${row.account==='êµí†µë¹„'?'selected':''}>êµí†µë¹„</option>
            <option value="í†µì‹ ë¹„" ${row.account==='í†µì‹ ë¹„'?'selected':''}>í†µì‹ ë¹„</option>
            <option value="ì‚¬ë¬´ë¹„" ${row.account==='ì‚¬ë¬´ë¹„'?'selected':''}>ì‚¬ë¬´ë¹„</option>
            <option value="ì¶œì¥ì¼ë¹„" ${row.account==='ì¶œì¥ì¼ë¹„'?'selected':''}>ì¶œì¥ì¼ë¹„</option>
            <option value="ë³µë¦¬í›„ìƒë¹„" ${row.account==='ë³µë¦¬í›„ìƒë¹„'?'selected':''}>ë³µë¦¬í›„ìƒë¹„</option>
            <option value="ê¸°íƒ€" ${row.account==='ê¸°íƒ€'?'selected':''}>ê¸°íƒ€</option>
          </select>
        </td>
        <td><input type="number" class="bulk-input" data-field="amount" data-idx="${idx}" value="${row.amount||''}" placeholder="ê¸ˆì•¡" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td><input type="text" class="bulk-input" data-field="vendor" data-idx="${idx}" value="${row.vendor||''}" placeholder="ì—…ì†Œëª…" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td>
          <select class="bulk-input" data-field="costCode" data-idx="${idx}" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;">
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë²•ì¸(ë²•ì¸)" ${row.costCode==='ë²•ì¸(ë²•ì¸)'?'selected':''}>ë²•ì¸(ë²•ì¸)</option>
            <option value="ë²•ì¸(ê°œì¸)" ${row.costCode==='ë²•ì¸(ê°œì¸)'?'selected':''}>ë²•ì¸(ê°œì¸)</option>
            <option value="ê°œì¸(ê°œì¸)" ${row.costCode==='ê°œì¸(ê°œì¸)'?'selected':''}>ê°œì¸(ê°œì¸)</option>
            <option value="í˜„ê¸ˆ" ${row.costCode==='í˜„ê¸ˆ'?'selected':''}>í˜„ê¸ˆ</option>
            <option value="ê¸°íƒ€" ${row.costCode==='ê¸°íƒ€'?'selected':''}>ê¸°íƒ€</option>
          </select>
        </td>
        <td><input type="text" class="bulk-input" data-field="projectCode" data-idx="${idx}" value="${row.projectCode||''}" placeholder="í”„ë¡œì íŠ¸ì½”ë“œ" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td><input type="text" class="bulk-input" data-field="note" data-idx="${idx}" value="${row.note||''}" placeholder="ë©”ëª¨" style="width:100%;padding:4px;font-size:12px;border:1px solid #ddd;border-radius:4px;" /></td>
        <td style="text-align:center;">
          ${showWelfareCheckbox ? `<input type="checkbox" class="bulk-welfare-checkbox" data-idx="${idx}" ${row.welfareFlag==='Y'?'checked':''} style="width:18px;height:18px;cursor:pointer;" />` : '-'}
        </td>
        <td><button class="linkBtn" onclick="removeBulkRow(${idx})" style="color:#ef4444;">ì‚­ì œ</button></td>
      </tr>
    `;
    }).join("");

    dom.tbody.innerHTML = bulkRowsHTML + filtered.map(x => `
      <tr data-id="${x.id}">
        <td style="font-size:13px;font-weight:700;">${esc(x.memberName||"-")}</td>
        <td style="font-size:13px;font-weight:700;">${formatDate(x.usageDate)}</td>
        <td style="font-size:13px;font-weight:700;">${esc(x.description||"")}</td>
        <td style="font-size:13px;">${esc(x.account||"-")}</td>
        <td class="num" style="font-size:14px;font-weight:900;">${nf.format(x.amount||0)}</td>
        <td style="font-size:13px;">${esc(x.vendor||"-")}</td>
        <td style="font-size:13px;">${esc(x.costCode||"-")}</td>
        <td style="font-size:13px;">${esc(x.projectCode||"-")}</td>
        <td style="font-size:12px;color:var(--muted);">${esc(x.note||"-")}</td>
        <td style="text-align:center;font-size:13px;">${x.welfareFlag === 'Y' ? 'âœ“' : '-'}</td>
        <td>
          <button class="linkBtn" data-edit="${x.id}">ìˆ˜ì •</button>
        </td>
      </tr>
    `).join("");

    // ì¼ê´„ ì…ë ¥ í•„ë“œ ë³€ê²½ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.querySelectorAll('.bulk-input').forEach(input => {
      input.addEventListener('input', (e) => {
        const idx = parseInt(e.target.dataset.idx);
        const field = e.target.dataset.field;
        bulkEditRows[idx][field] = e.target.value;
      });
    });

    // ê³„ì • ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ (ë³µë¦¬í›„ìƒë¹„ ì„ íƒ ì‹œ ì²´í¬ë°•ìŠ¤ë§Œ í‘œì‹œ)
    document.querySelectorAll('.bulk-account').forEach(select => {
      select.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.idx);
        const isWelfareAccount = e.target.value === 'ë³µë¦¬í›„ìƒë¹„';

        // ë³µë¦¬í›„ìƒë¹„ê°€ ì•„ë‹Œ ê²½ìš° welfareFlagë¥¼ 'N'ìœ¼ë¡œ ì„¤ì •
        if(!isWelfareAccount){
          bulkEditRows[idx].welfareFlag = 'N';
        }

        // í™”ë©´ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì²´í¬ë°•ìŠ¤ í‘œì‹œ/ìˆ¨ê¹€
        renderTable();
      });
    });

    // ë³µì§€ë¹„ ì²´í¬ë°•ìŠ¤ ë³€ê²½ ì´ë²¤íŠ¸
    document.querySelectorAll('.bulk-welfare-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        const idx = parseInt(e.target.dataset.idx);
        bulkEditRows[idx].welfareFlag = e.target.checked ? 'Y' : 'N';
      });
    });

    dom.statCount.textContent = nf.format(filtered.length);
    dom.statSum.textContent = nf.format(s);
    dom.statAvg.textContent = nf.format(avg);
  }

  function openNew(){
    currentItem = null;
    dom.mTitle.textContent = "ì§€ì¶œ ì¶”ê°€";
    dom.mId.value = "";
    dom.mDate.value = todayISO();

    const savedMemberId = sessionStorage.getItem('selectedMemberId') || localStorage.getItem('selectedMemberId') || dom.filterMember.value;
    dom.mMember.value = savedMemberId || "";

    dom.mVendor.value = "";
    dom.mAmount.value = "";
    dom.mAccount.value = "";
    dom.mCost.value = "";
    dom.mProject.value = "PJ00000000";
    dom.mDesc.value = "";
    dom.mNote.value = "";
    dom.mWelfareFlag.checked = false;
    dom.welfareFlagContainer.style.display = "none";
    dom.btnDelete.style.display = "none";
    openModal();
  }

  async function viewItem(id){
    try{
      const res = await fetch(`${API_BASE}/expense-items/${id}`);
      currentItem = await res.json();

      dom.mTitle.textContent = "ì§€ì¶œ ìˆ˜ì •";
      dom.mId.value = currentItem.id;
      dom.mDate.value = currentItem.usageDate;
      dom.mMember.value = currentItem.memberId;
      dom.mVendor.value = currentItem.vendor||"";
      dom.mAmount.value = currentItem.amount;
      dom.mAccount.value = currentItem.account||"";
      dom.mCost.value = currentItem.costCode||"";
      dom.mProject.value = currentItem.projectCode||"";
      dom.mDesc.value = currentItem.description||"";
      dom.mNote.value = currentItem.note||"";
      dom.mWelfareFlag.checked = currentItem.welfareFlag === 'Y';

      // Show welfare flag container only if account is "ë³µë¦¬í›„ìƒë¹„"
      if(currentItem.account === "ë³µë¦¬í›„ìƒë¹„"){
        dom.welfareFlagContainer.style.display = "block";
      } else {
        dom.welfareFlagContainer.style.display = "none";
      }

      dom.btnDelete.style.display = "inline-flex";
      openModal();
    }catch(e){ console.error('í•­ëª© ë¡œë“œ ì‹¤íŒ¨:', e); alert('í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
  }

  async function saveItem(){
    const data = {
      memberId: parseInt(dom.mMember.value),
      usageDate: dom.mDate.value,
      description: dom.mDesc.value,
      account: dom.mAccount.value,
      amount: parseFloat(dom.mAmount.value),
      vendor: dom.mVendor.value,
      costCode: dom.mCost.value,
      projectCode: dom.mProject.value,
      note: dom.mNote.value,
      welfareFlag: dom.mWelfareFlag.checked ? 'Y' : 'N'
    };

    if(!data.memberId || !data.usageDate || !data.description || !data.account || !data.amount){
      alert('í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return;
    }

    // ë³µì§€ë¹„ ì²´í¬ ì‹œ ë‚¨ì€ ì˜ˆì‚° ê²€ì¦
    if(data.welfareFlag === 'Y'){
      console.log('[ë³µì§€ë¹„ ê²€ì¦] ì‹œì‘ - welfareFlag:', data.welfareFlag);
      const year = new Date(data.usageDate).getFullYear();
      console.log('[ë³µì§€ë¹„ ê²€ì¦] ì—°ë„:', year, 'ë©¤ë²„ID:', data.memberId);

      try{
        const res = await fetch(`${API_BASE}/expense-items/welfare-usage/${data.memberId}/${year}`);
        console.log('[ë³µì§€ë¹„ ê²€ì¦] API ì‘ë‹µ ìƒíƒœ:', res.status);

        if(res.ok){
          const welfareData = await res.json();
          console.log('[ë³µì§€ë¹„ ê²€ì¦] ë³µì§€ë¹„ ë°ì´í„°:', welfareData);

          const currentItemId = dom.mId.value;
          console.log('[ë³µì§€ë¹„ ê²€ì¦] í˜„ì¬ í•­ëª© ID:', currentItemId);

          // í˜„ì¬ ìˆ˜ì • ì¤‘ì¸ í•­ëª©ì˜ ê¸°ì¡´ ë³µì§€ë¹„ ê¸ˆì•¡ ì°¾ê¸° (ìˆ˜ì • ì‹œ)
          let existingWelfareAmount = 0;
          if(currentItemId && currentItem && currentItem.welfareFlag === 'Y'){
            existingWelfareAmount = currentItem.amount || 0;
            console.log('[ë³µì§€ë¹„ ê²€ì¦] ê¸°ì¡´ ë³µì§€ë¹„ ê¸ˆì•¡:', existingWelfareAmount);
          }

          // ì‹¤ì œ ë‚¨ì€ ê¸ˆì•¡ = ì—°ê°„ ë‚¨ì€ ê¸ˆì•¡ + ê¸°ì¡´ ë³µì§€ë¹„ ê¸ˆì•¡ (ìˆ˜ì • ì‹œ)
          const actualRemaining = welfareData.annualRemaining + existingWelfareAmount;
          console.log('[ë³µì§€ë¹„ ê²€ì¦] ì‹¤ì œ ë‚¨ì€ ê¸ˆì•¡:', actualRemaining, 'ì…ë ¥ ê¸ˆì•¡:', data.amount);

          if(data.amount > actualRemaining){
            const maxAmount = actualRemaining;
            console.log('[ë³µì§€ë¹„ ê²€ì¦] ì˜ˆì‚° ì´ˆê³¼! ìµœëŒ€ ê¸ˆì•¡:', maxAmount);
            alert(`ë³µì§€ë¹„ ì˜ˆì‚°ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!\në‚¨ì€ ë³µì§€ë¹„: ${nf.format(actualRemaining)}ì›\nì…ë ¥ ê¸ˆì•¡: ${nf.format(data.amount)}ì›\nì´ˆê³¼ ê¸ˆì•¡: ${nf.format(data.amount - actualRemaining)}ì›\n\nìµœëŒ€ ì‚¬ìš© ê°€ëŠ¥ ê¸ˆì•¡ìœ¼ë¡œ ì¡°ì •í•©ë‹ˆë‹¤.`);
            data.amount = maxAmount;
            dom.mAmount.value = maxAmount;
            return; // ì‚¬ìš©ìê°€ ê¸ˆì•¡ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì €ì¥í•˜ë„ë¡ í•¨
          }else{
            console.log('[ë³µì§€ë¹„ ê²€ì¦] ì˜ˆì‚° ë‚´ ì‚¬ìš© - í†µê³¼');
          }
        }
      }catch(e){
        console.error('[ë³µì§€ë¹„ ê²€ì¦] ì˜¤ë¥˜ ë°œìƒ:', e);
        // ë³µì§€ë¹„ ê²€ì¦ ì‹¤íŒ¨ ì‹œì—ë„ ì €ì¥ì€ ì§„í–‰
      }
    }else{
      console.log('[ë³µì§€ë¹„ ê²€ì¦] ë³µì§€ë¹„ ì•„ë‹˜ - welfareFlag:', data.welfareFlag);
    }

    try{
      const id = dom.mId.value;
      const url = id ? `${API_BASE}/expense-items/${id}` : `${API_BASE}/expense-items`;
      const method = id ? 'PUT' : 'POST';

      const res = await fetch(url, {
        method, headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });

      if(res.ok){
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeModal();
        await loadItems();
        const memberId = dom.filterMember.value;
        if(memberId){
          loadWelfareUsage(memberId);
        }
      }else{ throw new Error('ì €ì¥ ì‹¤íŒ¨'); }
    }catch(e){ console.error('ì €ì¥ ì‹¤íŒ¨:', e); alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
  }

  async function deleteItem(){
    if(!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    const id = dom.mId.value; if(!id) return;

    try{
      const res = await fetch(`${API_BASE}/expense-items/${id}`, {method:'DELETE'});
      if(res.ok){
        alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeModal();
        await loadItems();
        const memberId = dom.filterMember.value;
        if(memberId){
          loadWelfareUsage(memberId);
        }
      }else{ throw new Error('ì‚­ì œ ì‹¤íŒ¨'); }
    }catch(e){ console.error('ì‚­ì œ ì‹¤íŒ¨:', e); alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
  }

  async function exportToExcel(){
    const filtered = applyFilters();

    if(filtered.length === 0){
      alert('ë‹¤ìš´ë¡œë“œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ì„ íƒëœ ë©¤ë²„ì™€ ë¶€ì„œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    const selectedMemberId = dom.filterMember.value;
    let memberName = 'ì „ì²´';
    let deptName = 'ì „ì²´';
    let parentDeptName = 'ì „ì²´';

    if(selectedMemberId){
      const member = members.find(m => m.id == selectedMemberId);
      if(member){
        memberName = member.name;
        const dept = departments.find(d => d.id == member.departmentId);
        if(dept){
          deptName = dept.name;
          // ë³¸ë¶€(ìƒìœ„ ë¶€ì„œ) ì •ë³´ ì°¾ê¸°
          if(dept.parentId){
            const parentDept = departments.find(d => d.id == dept.parentId);
            if(parentDept){
              parentDeptName = parentDept.name;
            }
          }
        }
      }
    }

    // ì„ íƒëœ ì›” ì •ë³´
    const yearMonth = dom.filterMonth.value || new Date().toISOString().substring(0, 7);

    // ì—‘ì…€ ë°ì´í„° ì¤€ë¹„ (í…œí”Œë¦¿ì— ë§ì¶° ë§¤í•‘)
    const excelItems = filtered.map(item => ({
      usageDate: item.usageDate || '',
      memberName: item.memberName || '',
      parentDeptName: parentDeptName,  // ë³¸ë¶€ ì •ë³´ ì¶”ê°€
      deptName: item.departmentName || '',
      description: item.description || '',
      account: item.account || '',
      amount: item.amount || 0,
      vendor: item.vendor || '',
      costCode: item.costCode || '',
      projectCode: item.projectCode || '',
      note: item.note || ''
    }));

    const requestData = {
      member: memberName,
      dept: deptName,
      yearMonth: yearMonth,
      items: excelItems
    };

    try {
      // í…œí”Œë¦¿ ê¸°ë°˜ ì—‘ì…€ ìƒì„± API í˜¸ì¶œ
      const response = await fetch('/api/expense-items/excel', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
      });

      if(!response.ok){
        throw new Error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');
      }

      // Blobìœ¼ë¡œ ë°›ì•„ì„œ ë‹¤ìš´ë¡œë“œ
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ì§€ì¶œë³´ê³ ì„œ_${memberName}_${yearMonth}.xlsx`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch(e){
      console.error('ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì˜¤ë¥˜:', e);
      alert('ì—‘ì…€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  async function loadWelfareUsage(memberId){
    if(!memberId){
      dom.welfareSection.style.display = 'none';
      return;
    }

    try{
      const year = new Date().getFullYear();
      const res = await fetch(`${API_BASE}/expense-items/welfare-usage/${memberId}/${year}`);
      if(!res.ok) throw new Error('ë³µì§€ë¹„ ì¡°íšŒ ì‹¤íŒ¨');

      const data = await res.json();

      // Clear quarters
      dom.welfareQuarters.innerHTML = '';

      // Add quarterly data
      data.quarters.forEach(q => {
        const remaining = q.remaining || 0;
        const isOver = remaining < 0;
        const color = isOver ? '#dc2626' : (remaining < 100000 ? '#f59e0b' : '#059669');

        const quarterDiv = document.createElement('div');
        quarterDiv.style.cssText = 'display:flex;justify-content:space-between;padding:4px 8px;background:#f9fafb;border-radius:4px;font-size:11px;';
        quarterDiv.innerHTML = `
          <span>Q${q.quarter}</span>
          <span><b>${nf.format(q.used || 0)}</b> / ${nf.format(q.budget || 0)}ì›</span>
        `;
        dom.welfareQuarters.appendChild(quarterDiv);
      });

      // Update annual summary
      dom.welfareAnnualUsed.textContent = nf.format(data.annualUsed || 0);
      dom.welfareAnnualBudget.textContent = nf.format(data.annualBudget || 0);
      dom.welfareAnnualRemaining.textContent = nf.format(data.annualRemaining || 0);
      dom.welfareAnnualRemaining.style.color = (data.annualRemaining < 0) ? '#dc2626' : '#059669';

      dom.welfareSection.style.display = 'block';
    }catch(e){
      console.error('ë³µì§€ë¹„ ì¡°íšŒ ì‹¤íŒ¨:', e);
      dom.welfareSection.style.display = 'none';
    }
  }

  // ì¼ê´„ í¸ì§‘ ê´€ë ¨ í•¨ìˆ˜
  function addBulkRow(){
    const memberId = dom.filterMember.value;
    if(!memberId){
      alert('ë©¤ë²„ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    const member = members.find(m => m.id == memberId);
    bulkEditRows.push({
      memberId: memberId,
      memberName: member ? member.name : '',
      usageDate: todayISO(),
      description: '',
      account: '',
      amount: '',
      vendor: '',
      costCode: '',
      projectCode: 'PJ00000000',
      note: '',
      welfareFlag: 'N'
    });
    dom.btnSaveBulk.style.display = 'inline-flex';
    renderTable();
  }

  window.removeBulkRow = function(idx){
    bulkEditRows.splice(idx, 1);
    if(bulkEditRows.length === 0){
      dom.btnSaveBulk.style.display = 'none';
    }
    renderTable();
  };

  async function saveBulk(){
    if(bulkEditRows.length === 0){
      alert('ì €ì¥í•  í–‰ì´ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    // ìœ íš¨ì„± ê²€ì‚¬
    for(let i = 0; i < bulkEditRows.length; i++){
      const row = bulkEditRows[i];
      if(!row.usageDate || !row.description || !row.amount){
        alert(`${i+1}ë²ˆì§¸ í–‰: ì‚¬ìš©ì¼ì‹œ, ì‚¬ìš©ë‚´ìš©, ê¸ˆì•¡ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.`);
        return;
      }
    }

    // ë³µì§€ë¹„ ì²´í¬: í˜„ì¬ ë¶„ê¸°ê¹Œì§€ì˜ ëˆ„ì  ë‚¨ì€ ê¸ˆì•¡ ì²´í¬ (ë¯¸ë˜ ë¶„ê¸° ì˜ˆì‚°ì€ ì‚¬ìš© ë¶ˆê°€)
    const memberId = bulkEditRows[0].memberId;
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1; // 1-12
    const currentQuarter = Math.ceil(currentMonth / 3); // 1-4

    // ì €ì¥í•˜ë ¤ëŠ” ë³µì§€ë¹„ í•­ëª©ë“¤
    const welfareRows = bulkEditRows.filter(row => row.welfareFlag === 'Y');
    const newWelfareAmount = welfareRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);

    if(newWelfareAmount > 0){
      try{
        // í˜„ì¬ ë³µì§€ë¹„ ì‚¬ìš© í˜„í™© ì¡°íšŒ
        const welfareRes = await fetch(`${API_BASE}/expense-items/welfare-usage/${memberId}/${currentYear}`);
        if(welfareRes.ok){
          const welfareSummary = await welfareRes.json();
          const quarters = welfareSummary.quarters || [];

          // í˜„ì¬ ë¶„ê¸°ê¹Œì§€ì˜ ëˆ„ì  ê°€ëŠ¥ ì˜ˆì‚° ê³„ì‚° (1ë¶„ê¸°~í˜„ì¬ë¶„ê¸°)
          let availableQuarters = quarters.filter(q => q.quarter <= currentQuarter);
          let totalAvailableBudget = availableQuarters.reduce((sum, q) => sum + (q.remaining || 0), 0);

          // ë¶„ê¸°ë³„ ë°°ë¶„ ì‹œë®¬ë ˆì´ì…˜
          let totalNewAmount = newWelfareAmount;
          let allocated = [];

          for(let q of availableQuarters){
            if(totalNewAmount <= 0) break;

            let allocatedToQuarter = Math.min(totalNewAmount, q.remaining);
            allocated.push({
              quarter: q.quarter,
              amount: allocatedToQuarter,
              remainingBefore: q.remaining,
              remainingAfter: q.remaining - allocatedToQuarter
            });
            totalNewAmount -= allocatedToQuarter;
          }

          // í•œë„ ì´ˆê³¼ ì²´í¬
          if(totalNewAmount > 0){
            // ì´ˆê³¼
            let message = `ë³µì§€ë¹„ í•œë„ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (í˜„ì¬ ${currentQuarter}ë¶„ê¸°).\n\n`;
            message += `[ì‚¬ìš© ê°€ëŠ¥ ì˜ˆì‚° (1~${currentQuarter}ë¶„ê¸°)]\n`;
            availableQuarters.forEach(q => {
              message += `${q.quarter}ë¶„ê¸°: ${nf.format(q.remaining)}ì›\n`;
            });
            message += `- ì´ ì‚¬ìš© ê°€ëŠ¥: ${nf.format(totalAvailableBudget)}ì›\n\n`;
            message += `ì¶”ê°€ ê¸ˆì•¡: ${nf.format(newWelfareAmount)}ì›\n`;
            message += `ì´ˆê³¼ ê¸ˆì•¡: ${nf.format(totalNewAmount)}ì›\n\n`;
            message += `ë³µì§€ë¹„ ì²´í¬ë¥¼ í•´ì œí•˜ê±°ë‚˜ ê¸ˆì•¡ì„ ì¡°ì •í•´ì£¼ì„¸ìš”.\n`;
            message += `(ë¯¸ë˜ ë¶„ê¸° ì˜ˆì‚°ì€ ë‹¹ê²¨ ì“¸ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)`;

            alert(message);
            return; // ì €ì¥ ì¤‘ë‹¨
          } else {
            // í•œë„ ë‚´ - ë¶„ê¸°ë³„ ë°°ë¶„ í‘œì‹œ
            let message = `ë³µì§€ë¹„ê°€ ë‹¤ìŒê³¼ ê°™ì´ ë°°ë¶„ë©ë‹ˆë‹¤.\n\n`;
            allocated.forEach(a => {
              if(a.amount > 0){
                message += `${a.quarter}ë¶„ê¸°: ${nf.format(a.amount)}ì› ì‚¬ìš©\n`;
                message += `  (ì”ì•¡: ${nf.format(a.remainingBefore)}ì› â†’ ${nf.format(a.remainingAfter)}ì›)\n`;
              }
            });
            message += `\nì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;

            const confirm = window.confirm(message);
            if(!confirm){
              return;
            }
          }
        }
      }catch(e){
        console.error('ë³µì§€ë¹„ í•œë„ ì²´í¬ ì‹¤íŒ¨:', e);
      }
    }

    try{
      // ëª¨ë“  í–‰ì„ ìˆœì°¨ì ìœ¼ë¡œ ì €ì¥
      for(const row of bulkEditRows){
        const data = {
          memberId: row.memberId,
          usageDate: row.usageDate,
          description: row.description,
          account: row.account,
          amount: parseFloat(row.amount) || 0,
          vendor: row.vendor,
          costCode: row.costCode,
          projectCode: row.projectCode,
          note: row.note,
          welfareFlag: row.welfareFlag
        };

        const res = await fetch(`${API_BASE}/expense-items`, {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(data)
        });

        if(!res.ok){
          throw new Error('ì €ì¥ ì‹¤íŒ¨');
        }
      }

      alert(`${bulkEditRows.length}ê±´ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      bulkEditRows = [];
      dom.btnSaveBulk.style.display = 'none';
      await loadItems();

      // ë³µì§€ë¹„ ì‚¬ìš© í˜„í™© ê°±ì‹ 
      const memberId = dom.filterMember.value;
      if(memberId){
        await loadWelfareUsage(memberId);
      }
    }catch(e){
      console.error('ì¼ê´„ ì €ì¥ ì‹¤íŒ¨:', e);
      alert('ì¼ê´„ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function bind(){
    dom.btnNew.addEventListener("click", openNew);
    dom.btnAddRow.addEventListener("click", addBulkRow);
    dom.btnSaveBulk.addEventListener("click", saveBulk);
    dom.btnBackToSchedule.addEventListener("click", ()=> window.location.href='schedule.html');
    dom.btnMapPage.addEventListener("click", ()=> window.location.href='http://70.90.150.126:8080/map.html');

    dom.filterParentDept.addEventListener("change", () => {
      const parentId = dom.filterParentDept.value;
      sessionStorage.setItem('expenseFilterParentDept', parentId);
      dom.filterChildDept.innerHTML = '<option value="">ì „ì²´ íŒ€</option>';
      dom.filterChildDept.value = '';
      sessionStorage.setItem('expenseFilterChildDept', '');
      dom.filterMember.innerHTML = '<option value="">ì „ì²´ ë©¤ë²„</option>';
      dom.filterMember.value = '';
      sessionStorage.setItem('expenseFilterMember', '');

      if(parentId){
        const childDepts = departments.filter(d => d.parentId == parentId);
        childDepts.forEach(d => {
          const opt = new Option(d.name, d.id);
          dom.filterChildDept.add(opt);
        });

        // ë³¸ë¶€ ì„ íƒ ì‹œ í•´ë‹¹ ë³¸ë¶€ì˜ ëª¨ë“  ë©¤ë²„ í‘œì‹œ
        const childDeptIds = childDepts.map(d => d.id);
        const filteredMembers = members.filter(m => childDeptIds.includes(m.departmentId));
        filteredMembers.forEach(m => {
          const deptName = m.department || '';
          const opt = new Option(`${m.name} (${deptName})`, m.id);
          dom.filterMember.add(opt);
        });
      } else {
        // ì „ì²´ ë³¸ë¶€ì¼ ë•Œ ëª¨ë“  ë©¤ë²„ í‘œì‹œ
        members.forEach(m => {
          const deptName = m.department || '';
          const opt = new Option(`${m.name} (${deptName})`, m.id);
          dom.filterMember.add(opt);
        });
      }
      // ë³¸ë¶€ ë³€ê²½ ì‹œ ë³µì§€ë¹„ ì„¹ì…˜ ìˆ¨ê¹€ ë° í™”ë©´ ê°±ì‹ 
      dom.welfareSection.style.display = 'none';
      renderTable();
    });

    dom.filterChildDept.addEventListener("change", () => {
      const childId = dom.filterChildDept.value;
      sessionStorage.setItem('expenseFilterChildDept', childId);
      dom.filterMember.innerHTML = '<option value="">ì „ì²´ ë©¤ë²„</option>';
      dom.filterMember.value = '';
      sessionStorage.setItem('expenseFilterMember', '');

      if(childId){
        const filteredMembers = members.filter(m => m.departmentId == childId);
        filteredMembers.forEach(m => {
          const opt = new Option(`${m.name} (${m.department||''})`, m.id);
          dom.filterMember.add(opt);
        });
      } else {
        const parentId = dom.filterParentDept.value;
        if(parentId){
          // íŒ€ì´ ì „ì²´ì¼ ë•Œ, ì„ íƒëœ ë³¸ë¶€ì˜ ëª¨ë“  ë©¤ë²„ í‘œì‹œ
          const childDepts = departments.filter(d => d.parentId == parentId);
          const childDeptIds = childDepts.map(d => d.id);
          const filteredMembers = members.filter(m => childDeptIds.includes(m.departmentId));
          filteredMembers.forEach(m => {
            const deptName = m.department || '';
            const opt = new Option(`${m.name} (${deptName})`, m.id);
            dom.filterMember.add(opt);
          });
        } else {
          // ë³¸ë¶€ë„ íŒ€ë„ ì „ì²´ì¼ ë•Œ ëª¨ë“  ë©¤ë²„ í‘œì‹œ
          members.forEach(m => {
            const deptName = m.department || '';
            const opt = new Option(`${m.name} (${deptName})`, m.id);
            dom.filterMember.add(opt);
          });
        }
      }
      // íŒ€ ë³€ê²½ ì‹œ ë³µì§€ë¹„ ì„¹ì…˜ ìˆ¨ê¹€
      dom.welfareSection.style.display = 'none';
      renderTable();
    });

    dom.tbody.addEventListener("click", (e) => {
      const edit = e.target.closest("[data-edit]");
      if(edit) viewItem(Number(edit.dataset.edit));
    });

    dom.btnClose.addEventListener("click", closeModal);
    dom.btnCancel.addEventListener("click", closeModal);
    dom.modal.addEventListener("click", (e)=>{ if(e.target === dom.modal) closeModal(); });
    document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeModal(); });

    dom.btnSave.addEventListener("click", saveItem);
    dom.btnDelete.addEventListener("click", deleteItem);
    dom.btnExportExcel.addEventListener("click", exportToExcel);

    // Show welfare flag checkbox only when account is "ë³µë¦¬í›„ìƒë¹„"
    dom.mAccount.addEventListener("change", () => {
      const isWelfareAccount = dom.mAccount.value === "ë³µë¦¬í›„ìƒë¹„";

      if(isWelfareAccount){
        dom.welfareFlagContainer.style.display = "block";
      } else {
        dom.welfareFlagContainer.style.display = "none";
        dom.mWelfareFlag.checked = false;
      }
    });

    dom.filterMember.addEventListener("change", () => {
      sessionStorage.setItem('expenseFilterMember', dom.filterMember.value);
      const memberId = dom.filterMember.value;

      // ë©¤ë²„ ì„ íƒ ì‹œ ì¼ê´„ í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
      if(memberId){
        dom.btnAddRow.style.display = 'inline-flex';
        dom.btnSaveBulk.style.display = bulkEditRows.length > 0 ? 'inline-flex' : 'none';
      } else {
        dom.btnAddRow.style.display = 'none';
        dom.btnSaveBulk.style.display = 'none';
        bulkEditRows = []; // ë©¤ë²„ ì„ íƒ í•´ì œ ì‹œ ì¼ê´„ í¸ì§‘ í–‰ ì´ˆê¸°í™”
      }

      loadWelfareUsage(memberId);
      renderTable();
    });
    dom.filterMonth.addEventListener("change", () => {
      sessionStorage.setItem('expenseFilterMonth', dom.filterMonth.value);
      renderTable();
    });
    dom.q.addEventListener("input", renderTable);

    dom.btnResetFilter.addEventListener("click", ()=>{
      dom.filterParentDept.value = "";
      dom.filterChildDept.value = "";
      dom.filterMember.value = "";
      dom.filterMonth.value = "";
      dom.q.value = "";
      sessionStorage.removeItem('expenseFilterParentDept');
      sessionStorage.removeItem('expenseFilterChildDept');
      sessionStorage.removeItem('expenseFilterMember');
      sessionStorage.removeItem('expenseFilterMonth');
      renderTable();
    });
  }

  function restoreFilters(){
    // schedule.htmlì—ì„œ ë„˜ì–´ì˜¨ ê°’ í™•ì¸
    const savedParent = sessionStorage.getItem('selectedParentDepartmentId') || sessionStorage.getItem('expenseFilterParentDept');
    const savedChild = sessionStorage.getItem('selectedDepartmentId') || sessionStorage.getItem('expenseFilterChildDept');
    const savedMember = sessionStorage.getItem('selectedMemberId') || sessionStorage.getItem('expenseFilterMember');

    if(savedParent){
      dom.filterParentDept.value = savedParent;
      sessionStorage.setItem('expenseFilterParentDept', savedParent);

      // ë³¸ë¶€ì— ì†í•œ íŒ€ë“¤ ë¡œë“œ
      const childDepts = departments.filter(d => d.parentId == savedParent);
      childDepts.forEach(d => {
        const opt = new Option(d.name, d.id);
        dom.filterChildDept.add(opt);
      });

      // ë³¸ë¶€ì— ì†í•œ ë©¤ë²„ë“¤ ë¡œë“œ
      const childDeptIds = childDepts.map(d => d.id);
      const filteredMembers = members.filter(m => childDeptIds.includes(m.departmentId));
      filteredMembers.forEach(m => {
        const deptName = m.department || '';
        const opt = new Option(`${m.name} (${deptName})`, m.id);
        dom.filterMember.add(opt);
      });
    }

    if(savedChild){
      setTimeout(() => {
        dom.filterChildDept.value = savedChild;
        sessionStorage.setItem('expenseFilterChildDept', savedChild);

        // íŒ€ì— ì†í•œ ë©¤ë²„ë“¤ ë¡œë“œ
        dom.filterMember.innerHTML = '<option value="">ì „ì²´ ë©¤ë²„</option>';
        const filteredMembers = members.filter(m => m.departmentId == savedChild);
        filteredMembers.forEach(m => {
          const opt = new Option(`${m.name} (${m.department||''})`, m.id);
          dom.filterMember.add(opt);
        });
      }, 100);
    }

    if(savedMember){
      setTimeout(() => {
        dom.filterMember.value = savedMember;
        sessionStorage.setItem('expenseFilterMember', savedMember);
        // ë©¤ë²„ ì„ íƒ ì‹œ í–‰ ì¶”ê°€ ë²„íŠ¼ í‘œì‹œ
        dom.btnAddRow.style.display = 'inline-flex';
        dom.btnSaveBulk.style.display = bulkEditRows.length > 0 ? 'inline-flex' : 'none';
        loadWelfareUsage(savedMember);
        renderTable();
      }, 200);
    } else if(savedChild || savedParent){
      setTimeout(() => {
        renderTable();
      }, 300);
    }

    // ì›” í•„í„° ë³µì›
    const savedMonth = sessionStorage.getItem('expenseFilterMonth');
    if(savedMonth){
      dom.filterMonth.value = savedMonth;
    } else {
      // ê¸°ë³¸ê°’: ì´ë²ˆ ë‹¬
      const today = new Date();
      const currentMonth = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
      dom.filterMonth.value = currentMonth;
      sessionStorage.setItem('expenseFilterMonth', currentMonth);
    }

    // ë³µì§€ë¹„ ì‚¬ìš© í˜„í™© ë¡œë“œ
    if(savedMember){
      loadWelfareUsage(savedMember);
    }
  }

  async function init(){
    await loadDepartments();
    await loadMembers();
    await loadItems();
    restoreFilters();
    bind();
  }

  init();
</script>

</body>
</html>
